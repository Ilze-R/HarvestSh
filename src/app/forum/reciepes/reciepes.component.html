<ng-container *ngIf="userState$ | async as state">
  <app-nav [user]="state?.appData?.data?.user"></app-nav>
</ng-container>
<div class="container">
  <div class="bg-white d-block d-sm-flex side-nav">
    <app-dash-side-nav></app-dash-side-nav>
  </div>
  <div class="gardening-wrap">
    <div
      class="tab-pane forum-wrap"
      id="forum-tab"
      role="tabpanel"
      aria-labelledby="forum"
    >
      <div class="forum-topic-wrap flex-column">
        <div class="link-wrap">
          <a
            class="btn-link"
            [routerLink]="['/forum/gardening']"
            [ngClass]="{
              'active-link': activeLink === 'Gardening',
              'inactive-link': activeLink !== 'Gardening'
            }"
          >
            Gardening
          </a>
          <a
            [routerLink]="['/forum/recipes']"
            class="btn-link"
            [ngClass]="{
              'active-link': activeLink === 'Reciepes',
              'inactive-link': activeLink !== 'Reciepes'
            }"
          >
            Recipes
          </a>
          <a
            [routerLink]="['/forum/imade']"
            class="btn-link"
            [ngClass]="{
              'active-link': activeLink === 'Imade',
              'inactive-link': activeLink !== 'Imade'
            }"
          >
            I made this
          </a>
          <a
            [routerLink]="['/forum/other']"
            class="btn-link"
            [ngClass]="{
              'active-link': activeLink === 'Other',
              'inactive-link': activeLink !== 'Other'
            }"
          >
            Other
          </a>
        </div>
      </div>
    </div>
    <ng-container
      *ngIf="recipePostState$ | async as state"
      [ngSwitch]="state.dataState"
    >
      <div class="add-post-wrap">
        <svg
          xmlns="http://www.w3.org/2000/svg"
          width="27"
          height="27"
          fill="#808080 "
          class="bi bi-plus-circle"
          viewBox="0 0 16 16"
          (click)="newRecipePostForm()"
        >
          <path
            d="M8 15A7 7 0 1 1 8 1a7 7 0 0 1 0 14zm0 1A8 8 0 1 0 8 0a8 8 0 0 0 0 16z"
          />
          <path
            d="M8 4a.5.5 0 0 1 .5.5v3h3a.5.5 0 0 1 0 1h-3v3a.5.5 0 0 1-1 0v-3h-3a.5.5 0 0 1 0-1h3v-3A.5.5 0 0 1 8 4z"
          />
        </svg>
      </div>
      <div
        class="card mb-3 gardening-wrap"
        *ngFor="let post of state?.appData?.data?.posts; let i = index"
        [ngClass]="{ 'no-hover': clickedIndex === i }"
      >
        <div class="card-body">
          <div class="post-img-content-position">
            <div>
              <div class="title-wrap">
                <div>
                  <img
                    class="user-img"
                    src="{{ post.user_image_url }}"
                    alt=""
                  />
                </div>
                <div>
                  <h6 class="card-title">{{ post?.title }}</h6>
                  <p *ngIf="clickedIndex !== i" class="card-date">
                    Last updated
                    {{ formatTimeDifference(post.date | date) }}
                  </p>
                </div>
              </div>
              <img src="{{ post.img_url }}" alt="post image" />
            </div>
            <div class="post-text-wrap">
              <p *ngIf="clickedIndex !== i" class="card-text">
                {{ post?.description | shorten : 200 }}
              </p>
              <p *ngIf="clickedIndex === i">{{ post?.description }}</p>
            </div>
            <div class="dots-icon-wrap">
              <ng-container
                *ngIf="userState$ | async as user"
                [ngSwitch]="user.dataState"
              >
                <div
                  *ngIf="
                    user?.appData?.data?.user?.imageUrl === post.user_image_url
                  "
                  class="dropdown edit-delete-icon"
                  matTooltip="Edit or delete"
                  matTooltipPosition="above"
                  [matTooltipDisabled]="!toggleActive"
                >
                  <div
                    id="dropdownMenuButton"
                    data-bs-toggle="dropdown"
                    aria-haspopup="true"
                    aria-expanded="false"
                    (click)="disableTooltip()"
                  >
                    <span>
                      <svg
                        xmlns="http://www.w3.org/2000/svg"
                        width="16"
                        height="16"
                        fill="currentColor"
                        class="bi bi-three-dots"
                        viewBox="0 0 16 16"
                      >
                        <path
                          d="M3 9.5a1.5 1.5 0 1 1 0-3 1.5 1.5 0 0 1 0 3zm5 0a1.5 1.5 0 1 1 0-3 1.5 1.5 0 0 1 0 3zm5 0a1.5 1.5 0 1 1 0-3 1.5 1.5 0 0 1 0 3z"
                        /></svg
                    ></span>
                  </div>
                  <div
                    class="dropdown-menu"
                    aria-labelledby="dropdownMenuButton"
                  >
                    <!-- <a class="dropdown-item" (click)="editComment(j)">Edit </a> -->
                    <a class="dropdown-item" (click)="deleteRecipePost(post.id)"
                      >Delete</a
                    >
                  </div>
                </div>
                <div
                  class="not-logged-padding"
                  *ngIf="
                    user?.appData?.data?.user?.imageUrl !== post.user_image_url
                  "
                ></div>
              </ng-container>
            </div>
          </div>
          <ng-container *ngIf="userState$ | async as state">
            <!-- <img
              class="likes-icon"
              src="./like-icon.png"
              alt="actual likes"
              [ngClass]="{ liked: isLikedPost(post.id) }"
              (click)="updateLike(post.id, state?.appData?.data?.user.id)"
            /> -->
            <div class="like-icon-amount">
              <svg
                xmlns="http://www.w3.org/2000/svg"
                width="16"
                height="16"
                [style.fill]="isLikedPost(post.id) ? '#0000ff' : 'currentColor'"
                class="bi bi-hand-thumbs-up"
                viewBox="0 0 16 16"
                (click)="updatePostLike(post.id, state?.appData?.data?.user.id)"
              >
                <!-- <circle cx="8" cy="9" r="9" fill="#0000ff" /> -->
                <path
                  d="M8.864.046C7.908-.193 7.02.53 6.956 1.466c-.072 1.051-.23 2.016-.428 2.59-.125.36-.479 1.013-1.04 1.639-.557.623-1.282 1.178-2.131 1.41C2.685 7.288 2 7.87 2 8.72v4.001c0 .845.682 1.464 1.448 1.545 1.07.114 1.564.415 2.068.723l.048.03c.272.165.578.348.97.484.397.136.861.217 1.466.217h3.5c.937 0 1.599-.477 1.934-1.064a1.86 1.86 0 0 0 .254-.912c0-.152-.023-.312-.077-.464.201-.263.38-.578.488-.901.11-.33.172-.762.004-1.149.069-.13.12-.269.159-.403.077-.27.113-.568.113-.857 0-.288-.036-.585-.113-.856a2.144 2.144 0 0 0-.138-.362 1.9 1.9 0 0 0 .234-1.734c-.206-.592-.682-1.1-1.2-1.272-.847-.282-1.803-.276-2.516-.211a9.84 9.84 0 0 0-.443.05 9.365 9.365 0 0 0-.062-4.509A1.38 1.38 0 0 0 9.125.111L8.864.046zM11.5 14.721H8c-.51 0-.863-.069-1.14-.164-.281-.097-.506-.228-.776-.393l-.04-.024c-.555-.339-1.198-.731-2.49-.868-.333-.036-.554-.29-.554-.55V8.72c0-.254.226-.543.62-.65 1.095-.3 1.977-.996 2.614-1.708.635-.71 1.064-1.475 1.238-1.978.243-.7.407-1.768.482-2.85.025-.362.36-.594.667-.518l.262.066c.16.04.258.143.288.255a8.34 8.34 0 0 1-.145 4.725.5.5 0 0 0 .595.644l.003-.001.014-.003.058-.014a8.908 8.908 0 0 1 1.036-.157c.663-.06 1.457-.054 2.11.164.175.058.45.3.57.65.107.308.087.67-.266 1.022l-.353.353.353.354c.043.043.105.141.154.315.048.167.075.37.075.581 0 .212-.027.414-.075.582-.05.174-.111.272-.154.315l-.353.353.353.354c.047.047.109.177.005.488a2.224 2.224 0 0 1-.505.805l-.353.353.353.354c.006.005.041.05.041.17a.866.866 0 0 1-.121.416c-.165.288-.503.56-1.066.56z"
                />
              </svg>
              <p *ngIf="post.likes > 0 && !isLikedPost(post.id)">
                {{ post.likes }}
              </p>
              <p
                *ngIf="
                  post.likes > 0 &&
                  post.likes != 2 &&
                  post.likes != 1 &&
                  isLikedPost(post.id)
                "
              >
                You and {{ post.likes - 1 }} others
              </p>
              <p *ngIf="post.likes == 2 && isLikedPost(post.id)">
                You and {{ post.likes - 1 }} other
              </p>
            </div>
          </ng-container>
          <hr />
          <div class="form-group textarea-container add-comment-wrap">
            <ng-container
              *ngIf="userState$ | async as user"
              [ngSwitch]="user.dataState"
            >
              <img
                class="comment-form-photo"
                src="{{ user?.appData?.data?.user?.imageUrl }}"
                alt="profile photo icon"
              />
            </ng-container>
            <form
              class="comment-form"
              #commentForm="ngForm"
              (ngSubmit)="addRecipePostComment(commentForm)"
            >
              <div class="comment-input-wrap">
                <textarea
                  class="form-control content-input"
                  type="text"
                  ngModel
                  name="comment_text"
                  id="comment_text"
                  placeholder="Write a comment..."
                ></textarea>
                <button
                  class="btn-comment"
                  type="submit"
                  (click)="getDetails(i, post.id)"
                >
                  Comment
                </button>
              </div>
            </form>
          </div>
          <a class="view-comment" (click)="getDetails(i, post.id)"
            >View comments</a
          >
          <div
            *ngIf="allCommentsState$ | async as comments"
            [ngSwitch]="comments.dataState"
            class="comment-wrap"
          >
            <ng-container *ngIf="clickedIndex === i">
              <div
                *ngFor="
                  let comment of comments.appData?.data?.comments;
                  let j = index
                "
                class="comment"
              >
                <div class="comment-container">
                  <div>
                    <img
                      src="{{ comment.user_image_url }}"
                      alt="user image"
                      class="user-img-icon"
                    />
                  </div>
                  <div class="comment-content-like-icon-wrap">
                    <div class="comment-content-wrap">
                      <p class="username">{{ comment.username }}</p>
                      <p *ngIf="currentEditIndex !== j" class="comment-input">
                        {{ comment.comment_text }}
                      </p>
                      <app-comment-form
                        *ngIf="currentEditIndex === j"
                        [commentText]="comment.comment_text"
                        [commentId]="comment.id"
                        [fromRecipe]="fromRecipeComponent"
                      ></app-comment-form>
                    </div>
                    <div class="comment-below-interaction">
                      <div>
                        <span
                          class="like-span"
                          (click)="
                            updateCommentLike(
                              comment.comment_user_id,
                              comment.id
                            )
                          "
                          >Like</span
                        >
                        <span class="date-span">{{
                          comment.date | dateFormat
                        }}</span>
                      </div>
                      <div class="blue-like-wrap">
                        <img src="./blue-like.png" alt="" class="blue-like" />
                        <p
                          *ngIf="
                            comment.likes > 0 && !isLikedComment(comment.id)
                          "
                        >
                          {{ comment.likes }}
                        </p>
                      </div>
                    </div>
                  </div>
                </div>
                <ng-container
                  *ngIf="userState$ | async as user"
                  [ngSwitch]="user.dataState"
                >
                  <div
                    *ngIf="
                      user?.appData?.data?.user?.username === comment.username
                    "
                    class="dropdown edit-delete-icon"
                    matTooltip="Edit or delete"
                    matTooltipPosition="above"
                    [matTooltipDisabled]="!toggleActive"
                  >
                    <div
                      id="dropdownMenuButton"
                      data-bs-toggle="dropdown"
                      aria-haspopup="true"
                      aria-expanded="false"
                      (click)="disableTooltip()"
                    >
                      <span>
                        <svg
                          xmlns="http://www.w3.org/2000/svg"
                          width="16"
                          height="16"
                          fill="currentColor"
                          class="bi bi-three-dots"
                          viewBox="0 0 16 16"
                        >
                          <path
                            d="M3 9.5a1.5 1.5 0 1 1 0-3 1.5 1.5 0 0 1 0 3zm5 0a1.5 1.5 0 1 1 0-3 1.5 1.5 0 0 1 0 3zm5 0a1.5 1.5 0 1 1 0-3 1.5 1.5 0 0 1 0 3z"
                          /></svg
                      ></span>
                    </div>
                    <div
                      class="dropdown-menu"
                      aria-labelledby="dropdownMenuButton"
                    >
                      <a class="dropdown-item" (click)="editComment(j)"
                        >Edit
                      </a>
                      <a
                        class="dropdown-item"
                        (click)="deleteComment(comment.id)"
                        >Delete</a
                      >
                    </div>
                  </div>
                  <div
                    class="not-logged-padding"
                    *ngIf="
                      user?.appData?.data?.user?.username !== comment.username
                    "
                  ></div>
                </ng-container>
              </div>
            </ng-container>
          </div>
        </div>
      </div>
      <div class="pagination-wrap">
        <button
          class="btn-pagination"
          [disabled]="currentPage === 1"
          (click)="changePage(currentPage - 1)"
        >
          <svg
            xmlns="http://www.w3.org/2000/svg"
            width="14"
            height="14"
            fill="currentColor"
            class="bi bi-chevron-left"
            viewBox="0 0 16 16"
          >
            <path
              fill-rule="evenodd"
              d="M11.354 1.646a.5.5 0 0 1 0 .708L5.707 8l5.647 5.646a.5.5 0 0 1-.708.708l-6-6a.5.5 0 0 1 0-.708l6-6a.5.5 0 0 1 .708 0z"
            />
          </svg>
        </button>
        <div class="pagination-display">
          <p>{{ currentPage }}</p>
        </div>
        <button
          class="btn-pagination"
          [disabled]="count < 10"
          (click)="changePage(currentPage + 1)"
        >
          <svg
            xmlns="http://www.w3.org/2000/svg"
            width="14"
            height="14"
            fill="currentColor"
            class="bi bi-chevron-right"
            viewBox="0 0 16 16"
          >
            <path
              fill-rule="evenodd"
              d="M4.646 1.646a.5.5 0 0 1 .708 0l6 6a.5.5 0 0 1 0 .708l-6 6a.5.5 0 0 1-.708-.708L10.293 8 4.646 2.354a.5.5 0 0 1 0-.708z"
            />
          </svg>
        </button>
      </div>
    </ng-container>
  </div>
</div>
